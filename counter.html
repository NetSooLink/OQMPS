<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>OPD Token Registration</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: url('https://images.unsplash.com/photo-1586773860418-d37222d8fce3') no-repeat center center/cover;
        }
        /* Blur overlay */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.4);
            backdrop-filter: blur(8px);
            z-index: 0;
        }
        .container {
            position: relative;
            z-index: 1;
            background: rgba(255,255,255,0.95);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            width: 500px; /* rectangular */
            text-align: center;
        }
        h1 {
            margin-bottom: 15px;
            font-size: 1.8rem;
            color: #00695c;
        }
        .next-token {
            font-size: 2rem;
            font-weight: bold;
            color: #004d40;
            margin-bottom: 20px;
            padding: 12px;
            border: 2px solid #b2dfdb;
            border-radius: 8px;
            background: #e0f2f1;
        }
        form {
            width: 100%;
        }
        input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: 2px solid #b2dfdb;
            border-radius: 8px;
            font-size: 1.1rem;
            outline: none;
            box-sizing: border-box;
        }
        input:focus { border-color: #00796b; }
        button {
            width: 100%;
            padding: 14px;
            background: #00796b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        button:hover { background: #00695c; }
        .spinner {
            border: 3px solid #ffffff55;
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px; height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #result {
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            min-height: 1.4em;
        }
        .success { color: #2e7d32; }
        .error { color: #c62828; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>OPD Counter</h1>
    <div id="nextToken" class="next-token">Next Token: --</div>

    <form id="registerForm" autocomplete="off">
        <input
                type="tel"
                id="phone"
                name="phone"
                placeholder="07XXXXXXXX"
                required
                autocomplete="off"
                autofocus
                inputmode="numeric"
                pattern="07[0-9]{8}"
        />
        <button type="submit" id="registerBtn">Register</button>
    </form>

    <div id="result"></div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
    // Supabase connection
    const SUPABASE_URL = "https://kaxaggpkltuzeoxlgqhv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtheGFnZ3BrbHR1emVveGxncWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTA2NDksImV4cCI6MjA3MzU4NjY0OX0.2-ai2WKgV8lBgJxroJR8Atd3rzxrg5jo085E5UDwCr4";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById("registerForm");
    const phoneInput = document.getElementById("phone");
    const resultDiv = document.getElementById("result");
    const nextTokenDiv = document.getElementById("nextToken");
    const registerBtn = document.getElementById("registerBtn");

    // Get next token as (last auto-increment ID + 1), not row count
    async function refreshNextToken() {
        const { data, error } = await supabaseClient
            .from("patients")
            .select("patient_id")
            .order("patient_id", { ascending: false })
            .limit(1);

        if (error) {
            console.error(error);
            nextTokenDiv.textContent = "Next Token: --";
            return;
        }
        const lastId = (data && data.length > 0) ? data[0].patient_id : 0;
        nextTokenDiv.textContent = `Next Token: ${lastId + 1}`;
    }

    // Initial load
    refreshNextToken();

    // Hide message as soon as user types again
    phoneInput.addEventListener("input", () => {
        resultDiv.textContent = "";
        resultDiv.className = "";
    });

    // Enter to submit
    phoneInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            form.requestSubmit();
        }
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const phone = phoneInput.value.trim();

        // Validate Sri Lankan mobile pattern 07XXXXXXXX
        if (!/^07\d{8}$/.test(phone)) {
            resultDiv.textContent = "‚ùå Invalid phone number format.";
            resultDiv.className = "error fade-in";
            return;
        }

        // Show loading animation
        registerBtn.disabled = true;
        registerBtn.innerHTML = `<div class="spinner"></div> Registering...`;

        // 1Ô∏è‚É£ Insert patient
        const { data, error } = await supabaseClient
            .from("patients")
            .insert([{ phone: phone, status: "waiting" }])
            .select("patient_id");

        // Reset button
        registerBtn.disabled = false;
        registerBtn.textContent = "Register";

        if (error) {
            console.error(error);
            resultDiv.textContent = "‚ùå Error registering patient.";
            resultDiv.className = "error fade-in";
            return;
        }

        const token = data[0].patient_id;
        resultDiv.textContent = `‚úÖ Booked: ${token}`;
        resultDiv.className = "success fade-in";

        form.reset();
        phoneInput.focus();

        // Update "Next Token" using last ID + 1
        nextTokenDiv.textContent = `Next Token: ${token + 1}`;

        // 2Ô∏è‚É£ Calculate estimated waiting time
        // 1Ô∏è‚É£ Call Supabase function to get prediction
        // 1Ô∏è‚É£ Call Supabase function to get prediction
        console.log("üîç Requesting prediction for token:", token);

        const { data: prediction, error: predictErr } = await supabaseClient
            .rpc("predict_token_wait", { target_token: token });

        if (predictErr || !prediction || prediction.length === 0) {
            console.error("‚ùå Prediction error:", predictErr);
            console.log("üì≠ Prediction response:", prediction);
            return;
        }

        console.log("‚úÖ Prediction result:", prediction[0]);

// 2Ô∏è‚É£ Parse estimated_wait interval
        const intervalString = prediction[0].estimated_wait; // e.g., "00:05:00"
        console.log("‚è±Ô∏è Raw interval string:", intervalString);

        let estimatedMinutes = 5; // fallback
        if (typeof intervalString === 'string' && intervalString.includes(':')) {
            const parts = intervalString.split(':'); // ["hh", "mm", "ss"]
            const hours = parseInt(parts[0]);
            const minutes = parseInt(parts[1]);
            estimatedMinutes = (hours * 60) + minutes;
        } else {
            console.warn("‚ö†Ô∏è Unexpected interval format:", intervalString);
        }

        console.log("üßÆ Estimated wait time (minutes):", estimatedMinutes);

// 3Ô∏è‚É£ Calculate estimated call time
        const estimatedCallTime = new Date(Date.now() + estimatedMinutes * 60000);
        console.log("üìÖ Estimated call time:", estimatedCallTime.toString());

// 4Ô∏è‚É£ Format as hh:mmAM/PM
        const hours = estimatedCallTime.getHours();
        const minutes = estimatedCallTime.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = ((hours + 11) % 12 + 1);
        const displayMinutes = minutes.toString().padStart(2, '0');
        const timeString = `${displayHours}:${displayMinutes}${ampm}`;

        console.log("üïí Formatted time string:", timeString);

// 5Ô∏è‚É£ Insert into sms_queue
        const message =
            `Dear patient,\n` +
            `Your token number: ${token}\n` +
            `Estimated consultation time: ${timeString}`;

        console.log("üì® SMS message:", message);

        const { error: smsErr } = await supabaseClient
            .from("sms_queue")
            .insert([{ phone: phone, message: message }]);

        if (smsErr) {
            console.error("‚ùå Error adding to sms_queue:", smsErr);
        } else {
            console.log("‚úÖ SMS queued successfully for phone:", phone);
        }


    });

</script>
</body>
</html>
